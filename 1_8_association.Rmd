---
title: "Measuring association"
author: "Albert Cobos"
output: 
  ioslides_presentation:
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning=FALSE,
                      comment=NA)

library(dplyr)
library(ggformula)
library(mosaic)
```

## Association = Probabilistic relationship

Scenario     Formally              Implication (meaning)
--------     ---------------       -----------------------
Independent  Pr(Y|X) = Pr(Y)       Distibution of Y is equal for all X
Related      Pr(Y|X) $\ne$ Pr(Y)       Distribution of Y is NOT equal for all X

</br>

Cases:

- X and Y are both categorical
- One of each type
- X and Y are both quantitative


## Independence

Distibution of Y is equal for all X

```{r fig.height=3.5, fig.width=10, fig.align='center'}

par(mar=c(4,4,2,2))


# Independence ----

# Categorical
X <- rep(LETTERS[1:3], 100)
Y <- c(rep("A", 75), rep("B", 225))

p1 <- gf_props(~ X, fill= ~ Y, position="fill") +
  theme(legend.position="none") +
  ggtitle("Categorical X and Y")

# One of each type
set.seed(1)
Y2 <- 100 +  rnorm(100)
Y2 <- rep(Y2,3)
X2 <- rep(LETTERS[1:3], 100)

p2 <- gf_boxplot(Y2 ~ X2) +
  xlab("X") + ylab("Y") +
    theme(axis.text.y=element_blank(),axis.ticks.y=element_blank()) +
  ggtitle("Categorical X and quantitative Y")


# Quantis 
set.seed(123)
X3 <- seq(0.25,100,0.25)
Y3 <- 100 +  rnorm(length(X3))
p3 <- gf_point(Y3 ~ X3) +
  xlab("X") + ylab("Y") +
  theme(axis.text.x=element_blank(), axis.text.y=element_blank(),
        axis.ticks.x=element_blank(), axis.ticks.y=element_blank()) +
  ggtitle("Quantitative X and Y")


library(gridExtra)
grid.arrange(p1, p2, p3, ncol = 3)

```

Any other pattern is non-independence (association)

## Association measures/analysis

```{r}
tibble(Variables = c("Categorical (both)", "One quantitative and one categorical", "Quantitative (both)"),
          `Measures/analysis` = c("chi-square, RD, RR, OR, NNT", "mean difference", "covariance, correlation coefficients")
          ) %>%
  knitr::kable(format = "markdown")
```


## Quantitative X and Y:  Covariance

Differences wrt the mean of each variable

```{r covar, warning=FALSE, message=FALSE, fig.align='center', fig.height=4, fig.width=6}

library(readr)
d <- read_table2("https://raw.githubusercontent.com/acobos/Datasets/master/Anthropometric_measures.txt", 
    skip = 15)
par(mar=c(2,2,2,2), mfrow=c(1,1))
with (d,plot(Waist,Thorax,las=1, col="gray", xlab="x", ylab="y", cex=.7, xaxt='n', yaxt='n'))
abline(v=mean(d$Waist),col="darkgreen",lty=2)
abline(h=mean(d$Thorax),col="darkred",lty=2)
x = 113.9;  y = 121.6
points(x,y, pch = 19)
arrows(mean(d$Waist),y,x,y, lty=2, length = 0, col="gray")
text(mean(d$Waist), y+5, labels=expression(X-bar(X)), pos=4,col="darkgreen")
arrows(x,mean(d$Thorax),x,y, lty=2, length = 0, col="gray")
text(115, 112, labels=expression(Y-bar(Y)), pos=4, col="darkred")

text(140,85,"-",cex=2, col="darkblue")
text(140,130,"+",cex=2, col="darkblue")
text(80,85,"+",cex=2, col="darkblue")
text(80,130,"-",cex=2, col="darkblue")
mtext(expression(bar(X)), side=3, at= mean(d$Waist), col="darkgreen")
mtext(expression(bar(Y)), side=4, at= mean(d$Thorax), col="darkred", las=1)

```

Covariance(X,Y) = $\frac{1}{n-1} \sum{(X-\bar{X}) \times (Y-\bar{Y})}$

## Covariance 

```{r covpatterns, warning=FALSE, message=FALSE, fig.align='center', fig.height=5, fig.width=9}

par(mfrow=c(2,3), mar=c(2,2,3,2))

x = rnorm(1000)

sp = function(slope,error,tit,text) {
y = slope*x +  error * rnorm(1000)
prod = (x-mean(x)) * (y-mean(y))
color = ifelse(prod>0,"navy","red")

plot(x,y, 
     xaxt="n", yaxt="n", xlab="",ylab="", 
     xlim=c(-3,3), ylim=c(-3,3), pch=20, col=color)
title(main=tit, cex.main=.9)
abline(h=mean(y), v=mean(x), col="darkgray")
mtext(text, side=3, cex=.7) 
}

sp(1,0.5,"Direct relation: COV >>> 0","Great dominance +")

sp(-1,0.5,"Inverse relation: COV <<< 0","Great dominance -")

sp(0,0.5,"Independence: COV aprox. 0","Balance (none dominates)")


sp(1,1.5,"Direct relation: COV > 0","Mild dominance +")

sp(-1,1.5,"Inverse relation: COV < 0","Mild dominance -")

sp(0,1.5,"Independence: COV aprox. 0","Balance (none dominates)")
```



## Covariance: limitations

Has dimension: units of $X$ $\times$ units of $Y$

Therefore, its value depends on units (scale), which is undesirable

- Suppose dataset with $X$ body weight in *kg*, and $Y$ body height in *cm*  
- $Cov(XY)$ = 42.2 *kg* $\times$ *cm*  
- Suppose the same data, but $Y$ body weight in *m*  
- $Cov(XY)$ = 0.422 *kg* $\times$ *m*  

Not easy to decide if relation is mild, or strong...

Solution: get rid of units


## Correlation coefficients

Pearson's $r$:  $\quad \frac{Cov(X,Y)}{S_X  S_Y} \qquad$   measures *linear* relation (not *any kind of* relation!)

Spearman's $r_s$: $\quad$ Pearson's $r$ of the *ranks* of X and Y

\

- Both are dimensionless, with range -1 to +1

- Care with non-linearities and outliers, ALWAYS inspect scatterplot:

  - linear relation with no outliers:  Pearsons $r$ 

  - outliers, or non-linear but *monotonic*: Spearman's $r_s$

  - non-linear, non-monotonic: neither!
  
  

## Patterns of relationship

```{r fig.align='center', fig.height=5}


my_plot <- function (X, Y) {
plot(X, Y, xaxt='n', yaxt='n')
r <- paste("r =", round(cor(X,Y),2))
rs <- paste("r_s =" , round(cor(X,Y, method="spearman"),2))
title(paste(r, rs, sep = ", "))
}

par(mfrow=c(2,3), mar=c(2,2,3,2))

my_plot(d$Waist, d$Thorax)

my_plot(d$Wrist, d$Biceps)

my_plot(d$Age, d$Weight)

my_plot(d$Ankle, d$Knee)

y <- exp(x)
my_plot(x, y)

x <- seq(-10, 10)
y <- -x^2
my_plot(x, y)


```


## Correlation coefficients in R

```{r eval=FALSE, echo=TRUE}


mosaic::cor(var1 ~ var2, data = dataframe)                           # Pearson

mosaic::cor(var1 ~ var2, data = dataframe, method = "spearman")


# test of (linear) independence
mosaic::cor.test(var1 ~ var2, data = dataframe)

mosaic::cor.test(var1 ~ var2, data = dataframe, method = "spearman")

# Spearman test with ties
mosaic::cor.test(var1 ~ var2, data = dataframe, method = "spearman", exact=FALSE)


```

## Exercise

Is it reasonable to expect the weight at birth to be related to the mothers weight? If yes, do you expect a direct or an inverse relation? Use the birthwt dataset in package MASS to:

- Compute a new variable expressing the weight of mothers in kilograms (lwt_kg).

- Investigate if birthweights are related to the mother’s weights. 

- Compute the Pearson’s and the Spearman’s correlation coefficients. Which one would you choose and why?

- Test the null hypothesis that the correlation is zero in the population. Since a direct relation is expected conduct a one-sided test (see the help of the function to learn how to specify the appropriate alternative hypothesis). 

- What is the p-value? Does it provide evidence of a direct relation of birthweight and the mother’s weight?